<!--API_KEY = "ZulOVGAsPxVVFAIKUY0CYoBo5lkQ280LpIxPHVnEWM81uDn6"-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Train Departures</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-blue-100 text-blue-900 p-4">

    <div class="container mx-auto">
        <h2 class="text-xl font-bold text-center mb-2">ðŸš† Live Train Departures</h2>
        <p class="text-center text-blue-700 font-semibold mb-4">Euston â†’ Long Buckby</p>

        <div class="overflow-x-auto">
            <table class="w-full text-sm bg-white shadow-md border border-blue-400 border-collapse rounded-lg">
                <thead class="bg-blue-300 text-blue-900">
                    <tr>
                        <th class="p-2 border border-blue-400">Departure</th>
                        <th class="p-2 border border-blue-400">Platform</th>
                        <th class="p-2 border border-blue-400">Carriages</th>
                        <th class="p-2 border border-blue-400">Operator</th>
                        <th class="p-2 border border-blue-400">Status</th>
                        <th class="p-2 border border-blue-400">Arrival</th>
                    </tr>
                </thead>
                <tbody id="trainData" class="text-center bg-white"></tbody>
            </table>
        </div>

        <footer class="mt-4 text-center text-sm text-blue-700">
            Last updated: <span id="lastUpdated">Just now</span> <br>
            <span>Refreshes every 30 seconds</span>
        </footer>

        <div id="nrccMessages" class="mt-4 text-center text-blue-700 font-semibold"></div>
    </div>

    <!-- Modal for Full JSON -->
    <div id="jsonModal" class="fixed inset-0 bg-gray-900 bg-opacity-80 hidden flex justify-center items-center p-4">
        <div class="bg-white p-6 rounded-lg shadow-lg max-w-2xl w-full relative">
            <h3 class="text-lg font-bold mb-2">Train Details</h3>
            <pre id="jsonContent" class="text-xs p-3 bg-gray-100 border rounded max-h-96 overflow-auto"></pre>
            <button onclick="closeModal()" class="mt-3 px-4 py-2 bg-blue-600 text-white rounded">Close</button>
        </div>
    </div>

    <script>
        const API_KEY = "ZulOVGAsPxVVFAIKUY0CYoBo5lkQ280LpIxPHVnEWM81uDn6"; // Replace with actual API key
        const API_URL = "https://api1.raildata.org.uk/1010-live-departure-board---staff-version1_0/LDBSVWS/api/20220120/GetDepBoardWithDetails/EUS/";
        const refreshInterval = 30000; // 30 seconds

        // ðŸ“Œ Fetch & Display Train Data
        async function fetchTrainData() {
            const now = new Date();
            const formattedTime = now.toISOString().replace(/[-:]/g, '').split('.')[0]; // Convert to yyyyMMddTHHmmss

            try {
                const response = await fetch(`${API_URL}${formattedTime}?filterCRS=LBK&filterType=to&numRows=5&timeWindow=120`, {
                    headers: { "x-apikey": API_KEY }
                });

                if (!response.ok) throw new Error(`HTTP Error ${response.status}`);

                const data = await response.json();
                const tableBody = document.getElementById("trainData");
                tableBody.innerHTML = "";

                if (!data.trainServices || data.trainServices.length === 0) {
                    tableBody.innerHTML = `<tr><td colspan="6" class="p-3 text-gray-500">No trains found</td></tr>`;
                    return;
                }

                data.trainServices.forEach(train => {
                    const departureTime = formatTime(train.std);
                    const expectedTime = formatTime(train.etd);
                    const delayMinutes = calculateDelay(train.std, train.etd);
                    const departureFormatted = departureTime + formatExpectedTime(expectedTime, departureTime, delayMinutes);

                    const arrival = train.subsequentLocations && train.subsequentLocations.length > 0
                        ? train.subsequentLocations[train.subsequentLocations.length - 1]
                        : null;
                    const arrivalTime = formatTime(arrival?.sta);
                    const expectedArrival = formatTime(arrival?.eta) || arrivalTime;
                    const arrivalDelay = calculateDelay(arrivalTime, expectedArrival);
                    const arrivalFormatted = arrivalTime + formatExpectedTime(expectedArrival, arrivalTime, arrivalDelay);

                    const platform = train.platform || 'TBA';
                    const platformClass = train.platformIsHidden ? "text-red-600 font-bold" : "";

                    const numCoaches = train.formation?.coaches?.length || "Unknown";
                    const isCancelled = train.isCancelled;
                    const hasDelay = expectedTime !== "On time" && expectedTime !== departureTime;

                    let status = "On Time";
                    if (isCancelled) status = "Cancelled";
                    else if (hasDelay) status = "Delayed";

                    const statusLink = `<a href="#" onclick='showJson(${JSON.stringify(train)})' class="text-blue-700 underline">${status}</a>`;

                    const row = document.createElement("tr");
                    row.innerHTML = `
                        <td class="p-2 border border-blue-400">${departureFormatted}</td>
                        <td class="p-2 border border-blue-400 ${platformClass}">${platform}</td>
                        <td class="p-2 border border-blue-400">${numCoaches}</td>
                        <td class="p-2 border border-blue-400">${train.operator || 'Unknown'}</td>
                        <td class="p-2 border border-blue-400">${statusLink}</td>
                        <td class="p-2 border border-blue-400">${arrivalFormatted}</td>
                    `;
                    tableBody.appendChild(row);
                });

                // Show NRCC Messages
                displayNrccMessages(data.nrccMessages);

            } catch (error) {
                console.error("Error fetching train data:", error);
                document.getElementById("trainData").innerHTML = `<tr><td colspan="6" class="p-3 text-red-500">Error loading train data</td></tr>`;
            } finally {
                document.getElementById("lastUpdated").textContent = new Date().toLocaleTimeString();
            }
        }

        // ðŸ“Œ Function to format ISO datetime to `HH:MM`
        function formatTime(isoString) {
            if (!isoString) return "N/A";
            const timeMatch = isoString.match(/T(\d{2}:\d{2})/);
            return timeMatch ? timeMatch[1] : "N/A";
        }

        // ðŸ“Œ Function to format expected time (only if different)
        function formatExpectedTime(expected, scheduled, delay) {
            if (!expected || expected === scheduled) return "";
            return ` (${expected})${delay > 0 ? ` +${delay} min` : ""}`;
        }

        // ðŸ“Œ Calculate Delay in Minutes
        function calculateDelay(std, etd) {
            if (!std || !etd || std === etd) return 0;
            const parseTime = (time) => {
                const [hh, mm] = time.split(':').map(Number);
                return hh * 60 + mm;
            };
            return parseTime(etd) - parseTime(std);
        }

        // ðŸ“Œ Display NRCC Messages (Proper Formatting)
        function displayNrccMessages(messages) {
            const nrccDiv = document.getElementById("nrccMessages");
            nrccDiv.innerHTML = "";

            if (!messages || messages.length === 0) {
                return;
            }

            // Box with correct formatting inside
            let messageBox = `
                <div class="mt-4 mx-auto w-full max-w-3xl border border-blue-400 rounded-lg p-3">
                    <p class="text-center text-sm font-semibold text-blue-700">National Rail Communications Centre (NRCC) Message:</p>
                    <div class="mt-2 text-center text-sm text-blue-700 font-normal">
            `;

            // Append messages inside the box (normal weight)
            messages.forEach(msg => {
                messageBox += `<p class="text-blue-700 font-normal">${msg.xhtmlMessage}</p>`;
            });

            messageBox += `</div></div>`; // Close divs properly
            nrccDiv.innerHTML = messageBox;
        }

        // ðŸ“Œ Show JSON Modal
        function showJson(trainData) {
            document.getElementById("jsonModal").classList.remove("hidden");
            document.getElementById("jsonContent").textContent = JSON.stringify(trainData, null, 4);
        }

        // ðŸ“Œ Close JSON Modal
        function closeModal() {
            document.getElementById("jsonModal").classList.add("hidden");
        }

        fetchTrainData();
        setInterval(fetchTrainData, refreshInterval);
    
    </script>

</body>
</html>
